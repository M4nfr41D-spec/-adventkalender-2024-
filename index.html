<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Adventkalender ‚Äì Pers√∂nlicher Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Erstelle deinen eigenen personalisierten Adventkalender mit deinen Fotos">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #020617 0%, #0f172a 50%, #020617 100%);
      color: #e5e7eb;
      min-height: 100vh;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .container {
      max-width: 700px;
      width: 100%;
    }

    h1 {
      text-align: center;
      margin-bottom: 8px;
      font-size: clamp(1.8rem, 4vw, 2.4rem);
      background: linear-gradient(135deg, #facc15, #fbbf24);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .hint {
      text-align: center;
      font-size: 0.9rem;
      color: #9ca3af;
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .hint strong {
      color: #22c55e;
    }

    .card {
      border-radius: 16px;
      border: 1px solid #374151;
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(10px);
      padding: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    label {
      display: block;
      margin-bottom: 12px;
      font-weight: 600;
      font-size: 1.05rem;
      color: #f3f4f6;
    }

    .file-input-wrapper {
      position: relative;
      margin-bottom: 16px;
    }

    input[type="file"] {
      width: 100%;
      padding: 14px;
      border: 2px dashed #4b5563;
      border-radius: 12px;
      background: rgba(31, 41, 55, 0.5);
      color: #d1d5db;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    input[type="file"]:hover {
      border-color: #22c55e;
      background: rgba(31, 41, 55, 0.8);
    }

    input[type="file"]::file-selector-button {
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(135deg, #16a34a, #22c55e);
      color: white;
      font-weight: 600;
      cursor: pointer;
      margin-right: 12px;
      transition: transform 0.2s ease;
    }

    input[type="file"]::file-selector-button:hover {
      transform: scale(1.05);
    }

    ul {
      font-size: 0.85rem;
      color: #9ca3af;
      padding-left: 20px;
      margin-bottom: 16px;
      line-height: 1.8;
    }

    ul li {
      margin-bottom: 6px;
    }

    .settings {
      background: rgba(31, 41, 55, 0.5);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .settings h3 {
      font-size: 0.95rem;
      color: #fbbf24;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .slider-container {
      margin-bottom: 12px;
    }

    .slider-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 0.85rem;
      color: #d1d5db;
    }

    .slider-value {
      color: #22c55e;
      font-weight: 600;
    }

    input[type="range"] {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #374151;
      outline: none;
      -webkit-appearance: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: linear-gradient(135deg, #16a34a, #22c55e);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(34, 197, 94, 0.4);
    }

    input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: linear-gradient(135deg, #16a34a, #22c55e);
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 8px rgba(34, 197, 94, 0.4);
    }

    button {
      width: 100%;
      padding: 14px 24px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, #16a34a, #22c55e);
      color: white;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 16px rgba(34, 197, 94, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .progress-container {
      display: none;
      margin-top: 20px;
      padding: 16px;
      background: rgba(31, 41, 55, 0.5);
      border-radius: 12px;
    }

    .progress-container.visible {
      display: block;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #374151;
      border-radius: 999px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #16a34a, #22c55e);
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 999px;
    }

    .progress-text {
      font-size: 0.85rem;
      color: #d1d5db;
      text-align: center;
    }

    .status {
      margin-top: 16px;
      padding: 12px;
      border-radius: 8px;
      font-size: 0.85rem;
      line-height: 1.6;
      display: none;
    }

    .status.visible {
      display: block;
    }

    .status.success {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #86efac;
    }

    .status.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #fca5a5;
    }

    .status.info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: #93c5fd;
    }

    code {
      background: #111827;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.85em;
      color: #fbbf24;
    }

    footer {
      text-align: center;
      margin-top: 32px;
      font-size: 0.8rem;
      color: #6b7280;
    }

    footer a {
      color: #22c55e;
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }

    @media (max-width: 600px) {
      .card {
        padding: 20px;
      }

      h1 {
        font-size: 1.6rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéÑ Adventkalender Generator</h1>
    <p class="hint">
      Erstelle deinen <strong>pers√∂nlichen Adventkalender</strong> mit eigenen Fotos.<br>
      Die Bilder bleiben auf deinem Ger√§t ‚Äì es wird eine einzelne HTML-Datei erzeugt,<br>
      die du per WhatsApp, E-Mail oder Link teilen kannst. ‚ú®
    </p>

    <div class="card">
      <label for="files-input">
        üì∏ W√§hle 1‚Äì24 Bilder aus (JPG oder PNG):
      </label>
      
      <div class="file-input-wrapper">
        <input 
          id="files-input" 
          type="file" 
          accept="image/jpeg,image/jpg,image/png,image/webp" 
          multiple
        >
      </div>

      <ul>
        <li>Die Reihenfolge richtet sich nach <strong>Dateinamen</strong> (alphabetisch sortiert)</li>
        <li>Bild 1 ‚Üí T√ºrchen 1, Bild 2 ‚Üí T√ºrchen 2, usw.</li>
        <li>Du kannst mit 1 Bild testen ‚Äì dann hat nur T√ºrchen 1 ein Foto</li>
        <li>Bilder werden automatisch komprimiert f√ºr schnelleren Versand</li>
      </ul>

      <div class="settings">
        <h3>‚öôÔ∏è Einstellungen</h3>
        
        <div class="slider-container">
          <div class="slider-label">
            <span>Bildqualit√§t (kleinere Dateigr√∂√üe = schnellerer Versand)</span>
            <span class="slider-value" id="quality-value">80%</span>
          </div>
          <input 
            type="range" 
            id="quality-slider" 
            min="50" 
            max="95" 
            value="80" 
            step="5"
          >
        </div>

        <div class="slider-container">
          <div class="slider-label">
            <span>Maximale Bildbreite (px)</span>
            <span class="slider-value" id="width-value">1200px</span>
          </div>
          <input 
            type="range" 
            id="width-slider" 
            min="800" 
            max="2000" 
            value="1200" 
            step="100"
          >
        </div>
      </div>

      <button id="generate-btn">
        <span>üéÅ</span>
        <span>Kalender erstellen</span>
      </button>

      <div class="progress-container" id="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
        <div class="progress-text" id="progress-text">Verarbeite Bilder...</div>
      </div>

      <div class="status" id="status"></div>
    </div>

    <footer>
      Made with ‚ù§Ô∏è for creating personal advent calendars<br>
      <a href="https://github.com/M4nfr41D-spec/ADVENT-ANDROID" target="_blank">View on GitHub</a>
    </footer>
  </div>

  <script>
    const TOTAL_DAYS = 24;
    const filesInput = document.getElementById('files-input');
    const statusEl = document.getElementById('status');
    const btn = document.getElementById('generate-btn');
    const progressContainer = document.getElementById('progress-container');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    const qualitySlider = document.getElementById('quality-slider');
    const qualityValue = document.getElementById('quality-value');
    const widthSlider = document.getElementById('width-slider');
    const widthValue = document.getElementById('width-value');

    // Update slider values
    qualitySlider.addEventListener('input', (e) => {
      qualityValue.textContent = e.target.value + '%';
    });

    widthSlider.addEventListener('input', (e) => {
      widthValue.textContent = e.target.value + 'px';
    });

    function showStatus(message, type = 'info') {
      statusEl.textContent = message;
      statusEl.className = 'status visible ' + type;
    }

    function hideStatus() {
      statusEl.className = 'status';
    }

    function updateProgress(percent, text) {
      progressFill.style.width = percent + '%';
      progressText.textContent = text;
    }

    function showProgress() {
      progressContainer.classList.add('visible');
    }

    function hideProgress() {
      progressContainer.classList.remove('visible');
      progressFill.style.width = '0%';
    }

    async function compressImage(file, maxWidth, quality) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = (e) => {
          const img = new Image();
          
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            // Resize if needed
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }

            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            // Convert to JPEG with specified quality
            canvas.toBlob(
              (blob) => {
                if (blob) {
                  const compressedReader = new FileReader();
                  compressedReader.onload = () => resolve(compressedReader.result);
                  compressedReader.onerror = reject;
                  compressedReader.readAsDataURL(blob);
                } else {
                  reject(new Error('Komprimierung fehlgeschlagen'));
                }
              },
              'image/jpeg',
              quality / 100
            );
          };

          img.onerror = () => reject(new Error('Bild konnte nicht geladen werden'));
          img.src = e.target.result;
        };

        reader.onerror = () => reject(new Error('Datei konnte nicht gelesen werden'));
        reader.readAsDataURL(file);
      });
    }

    btn.addEventListener('click', async () => {
      hideStatus();
      hideProgress();

      const fileList = filesInput.files;
      if (!fileList || fileList.length === 0) {
        showStatus('‚ö†Ô∏è Bitte mindestens 1 Bild ausw√§hlen.', 'error');
        return;
      }

      let count = fileList.length;
      const maxWidth = parseInt(widthSlider.value);
      const quality = parseInt(qualitySlider.value);

      if (count > TOTAL_DAYS) {
        showStatus(
          `‚ÑπÔ∏è Du hast ${count} Bilder ausgew√§hlt. Es werden nur die ersten ${TOTAL_DAYS} verwendet.`,
          'info'
        );
        count = TOTAL_DAYS;
      }

      const files = Array.from(fileList)
        .sort((a, b) =>
          a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: "base" })
        )
        .slice(0, count);

      btn.disabled = true;
      showProgress();

      try {
        const images = [];
        
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const day = i + 1;
          
          updateProgress(
            ((i + 1) / files.length) * 100,
            `Verarbeite Bild ${i + 1} von ${files.length} (T√ºrchen ${day})...`
          );

          const dataUrl = await compressImage(file, maxWidth, quality);
          
          images.push({
            day,
            name: file.name,
            src: dataUrl
          });
        }

        updateProgress(100, 'Erstelle Kalender-Datei...');

        const calendarHtml = buildCalendarHtml(images);
        const blob = new Blob([calendarHtml], { type: "text/html;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "mein_adventkalender_2024.html";
        a.click();
        URL.revokeObjectURL(url);

        hideProgress();
        showStatus(
          `‚úÖ Fertig! Deine Kalender-Datei wurde heruntergeladen.\n\n` +
          `üì± Du findest sie in deinem Download-Ordner.\n` +
          `üí¨ Die Datei kann per WhatsApp, E-Mail oder Cloud geteilt werden.\n` +
          `üåê Oder auf GitHub Pages hochladen f√ºr einen dauerhaften Link!`,
          'success'
        );
      } catch (err) {
        console.error(err);
        hideProgress();
        showStatus(
          '‚ùå Fehler beim Erstellen des Kalenders:\n' + 
          (err && err.message ? err.message : String(err)),
          'error'
        );
      } finally {
        btn.disabled = false;
      }
    });

    function buildCalendarHtml(images) {
      const imagesJson = JSON.stringify(images);
      const year = new Date().getFullYear();

      return `<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mein pers√∂nlicher Adventkalender ${year}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Afacad:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    :root {
      --bg-dark:#020617;
      --bg-card:rgba(15,23,42,0.9);
      --bg-card-open:rgba(22,163,74,0.9);
      --bg-card-locked:rgba(30,64,175,0.6);
      --accent-gold:#facc15;
      --accent-green:#16a34a;
      --text-light:#f9fafb;
      --text-muted:#9ca3af;
    }
    body {
      font-family:"Afacad",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      min-height:100vh;
      background:
        radial-gradient(circle at top left,#1e293b 0,transparent 55%),
        radial-gradient(circle at bottom right,#0f172a 0,transparent 55%),
        linear-gradient(135deg,#020617,#0b1120 50%,#020617 100%);
      color:var(--text-light);
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:24px 16px 40px;
      overflow-x:hidden;
      position:relative;
    }
    body::before {
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background-image:
        radial-gradient(circle at 10% 20%,rgba(255,255,255,0.4) 0,transparent 3px),
        radial-gradient(circle at 80% 10%,rgba(255,255,255,0.4) 0,transparent 3px),
        radial-gradient(circle at 30% 80%,rgba(255,255,255,0.4) 0,transparent 2px),
        radial-gradient(circle at 90% 70%,rgba(255,255,255,0.4) 0,transparent 2px);
      opacity:0.13;
      z-index:-1;
    }
    header {
      text-align:center;
      margin-bottom:24px;
      max-width:700px;
    }
    .badge {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 14px;
      border-radius:999px;
      border:1px solid rgba(250,204,21,0.4);
      background:rgba(15,23,42,0.7);
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:0.12em;
      color:var(--accent-gold);
      margin-bottom:12px;
    }
    .badge-dot {
      width:7px;height:7px;border-radius:999px;
      background:var(--accent-gold);
      box-shadow:0 0 12px rgba(250,204,21,0.7);
    }
    h1 {
      font-size:clamp(2.2rem,4vw,3rem);
      margin-bottom:8px;
    }
    h1 span { color:var(--accent-gold); }
    .subtitle { color:var(--text-muted); font-size:0.95rem; }
    .today-info { margin-top:8px;font-size:0.95rem;color:var(--accent-green); }
    .calendar-grid {
      margin-top:28px;
      display:grid;
      grid-template-columns:repeat(6,minmax(80px,1fr));
      gap:14px;
      width:100%;
      max-width:900px;
    }
    @media(max-width:900px){
      .calendar-grid { grid-template-columns:repeat(4,minmax(70px,1fr)); }
    }
    @media(max-width:600px){
      .calendar-grid { grid-template-columns:repeat(3,minmax(70px,1fr)); }
    }
    .door {
      position:relative;
      border-radius:16px;
      border:1px solid rgba(148,163,184,0.4);
      padding:10px;
      background:var(--bg-card);
      box-shadow:0 14px 30px rgba(15,23,42,0.7);
      cursor:pointer;
      transition:transform 0.18s ease,box-shadow 0.18s ease,background 0.2s ease,border-color 0.2s ease;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:space-between;
      min-height:105px;
    }
    .door::before {
      content:"";
      position:absolute;
      inset:0;
      border-radius:inherit;
      border:1px solid rgba(248,250,252,0.04);
      pointer-events:none;
    }
    .door:hover {
      transform:translateY(-3px);
      box-shadow:0 18px 32px rgba(15,23,42,0.9);
    }
    .door-number {
      font-size:1.6rem;
      font-weight:700;
      text-shadow:0 0 12px rgba(248,250,252,0.6);
    }
    .door-label {
      font-size:0.75rem;
      text-transform:uppercase;
      letter-spacing:0.12em;
      color:var(--text-muted);
    }
    .door-status {
      margin-top:6px;
      font-size:0.8rem;
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(15,23,42,0.85);
      border:1px solid transparent;
    }
    .door.locked {
      background:var(--bg-card-locked);
      cursor:not-allowed;
    }
    .door.locked .door-status {
      border-color:rgba(37,99,235,0.5);
      color:#bfdbfe;
    }
    .door.locked .door-number { color:#dbeafe; }
    .door.unlocked { border-color:rgba(74,222,128,0.8); }
    .door.unlocked .door-status {
      border-color:rgba(22,163,74,0.7);
      color:#bbf7d0;
    }
    .door.opened {
      background:var(--bg-card-open);
      border-color:rgba(250,250,250,0.7);
      transform:translateY(-2px);
    }
    .door.opened .door-label { color:#ecfdf5; }
    .door.opened .door-status {
      background:rgba(6,95,70,0.9);
      border-color:rgba(22,163,74,1);
      color:#bbf7d0;
    }
    .door.opened .door-number { color:#fef9c3; }
    footer {
      margin-top:28px;
      font-size:0.8rem;
      color:var(--text-muted);
      text-align:center;
      max-width:600px;
    }
    .modal-backdrop {
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.95);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
    }
    .modal-backdrop.visible { display:flex; }
    .modal {
      position:relative;
      max-width:900px;
      width:100%;
      max-height:90vh;
      background:radial-gradient(circle at top,#020617,#0b1120 45%,#020617 100%);
      border-radius:18px;
      border:1px solid rgba(148,163,184,0.6);
      padding:16px 16px 18px;
      display:flex;
      flex-direction:column;
      box-shadow:0 24px 80px rgba(15,23,42,0.9);
    }
    .modal-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
      gap:12px;
    }
    .modal-title { font-size:1rem;font-weight:600; }
    .modal-actions {
      display:flex;
      align-items:center;
      gap:10px;
    }
    .btn {
      border-radius:999px;
      padding:6px 12px;
      font-size:0.85rem;
      border:1px solid transparent;
      background:rgba(15,23,42,0.9);
      color:var(--text-light);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      text-decoration:none;
    }
    .btn-primary {
      border-color:rgba(34,197,94,0.9);
      background:linear-gradient(135deg,#16a34a,#22c55e);
    }
    .btn-primary:hover { filter:brightness(1.05); }
    .btn-ghost { border-color:rgba(148,163,184,0.6); }
    .btn-ghost:hover { background:rgba(15,23,42,1); }
    .modal-img-wrapper {
      position:relative;
      flex:1;
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(30,64,175,0.7);
      background:radial-gradient(circle at center,#020617,#0b1120 60%);
    }
    .modal-img {
      width:100%;height:100%;object-fit:contain;display:block;
    }
    .modal-hint {
      margin-top:8px;
      font-size:0.75rem;
      color:var(--text-muted);
      display:flex;
      justify-content:space-between;
      gap:8px;
    }
    @media(max-width:600px){
      .modal { padding:12px;border-radius:14px; }
      .modal-title { font-size:0.9rem; }
      .btn { padding:5px 10px; }
      .modal-hint { flex-direction:column; }
    }
  </style>
</head>
<body>
  <header>
    <div class="badge">
      <span class="badge-dot"></span>
      <span>Pers√∂nlicher Adventkalender ${year}</span>
    </div>
    <h1>Dein <span>Weihnachts-Adventkalender</span></h1>
    <p class="subtitle">
      Jeden Tag ein Bild ‚Äì erstellt mit deinem eigenen Generator.
    </p>
    <p class="today-info" id="today-info"></p>
  </header>

  <main class="calendar-grid" id="calendar-grid"></main>

  <footer>
    Ge√∂ffnete T√ºrchen bleiben auf diesem Ger√§t gespeichert, auch wenn du die Seite neu l√§dst.
  </footer>

  <div class="modal-backdrop" id="photo-modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <div class="modal-header">
        <div class="modal-title" id="modal-title">T√ºrchen</div>
        <div class="modal-actions">
          <a id="download-link" class="btn btn-primary" download>
            <span>üì• Bild herunterladen</span>
          </a>
          <button class="btn btn-ghost" id="close-modal-btn">Schlie√üen ‚úï</button>
        </div>
      </div>
      <div class="modal-img-wrapper">
        <img id="modal-image" class="modal-img" alt="Adventkalender Bild" />
      </div>
      <div class="modal-hint">
        <span>üîç Bild zoomen: mit den Fingern oder per Browser-Zoom.</span>
        <span>üíæ Download: Button oben benutzen.</span>
      </div>
    </div>
  </div>

  <script>
    const CALENDAR_IMAGES = ${imagesJson};
    const TOTAL_DAYS = 24;
    const now = new Date();
    const currentYear = ${year};

    const imageMap = {};
    for (const img of CALENDAR_IMAGES) {
      imageMap[img.day] = img;
    }

    const STORAGE_KEY = "advent-opened-" + currentYear + "-personal";

    (function () {
      const todayInfoEl = document.getElementById("today-info");
      const grid = document.getElementById("calendar-grid");

      const modalBackdrop = document.getElementById("photo-modal-backdrop");
      const modalImage = document.getElementById("modal-image");
      const modalTitle = document.getElementById("modal-title");
      const downloadLink = document.getElementById("download-link");
      const closeModalBtn = document.getElementById("close-modal-btn");

      let openedDays = loadOpenedDays();

      todayInfoEl.textContent = "Heute ist: " + formatDate(now);

      for (let day = 1; day <= TOTAL_DAYS; day++) {
        const door = document.createElement("button");
        door.classList.add("door");
        door.setAttribute("data-day", String(day));
        door.type = "button";

        const isUnlocked = isDoorUnlocked(day);
        const isOpened = openedDays.includes(day);
        const hasImage = !!imageMap[day];

        if (!isUnlocked) {
          door.classList.add("locked");
        } else {
          door.classList.add("unlocked");
        }

        if (isOpened && isUnlocked) {
          door.classList.add("opened");
        }

        door.innerHTML =
          '<div class="door-number">' + day + '</div>' +
          '<div class="door-label">Dezember</div>' +
          '<div class="door-status">' +
            '<span class="door-status-icon">' +
              (!isUnlocked ? "üîí" : (isOpened ? "üéâ" : (hasImage ? "üéÅ" : "‚úñÔ∏è"))) +
            '</span>' +
            '<span class="door-status-text">' +
              (!isUnlocked ? "Noch gesperrt" :
                (isOpened ? "Ge√∂ffnet" :
                  (hasImage ? "Bereit zum √ñffnen" : "Kein Bild hinterlegt"))) +
            '</span>' +
          '</div>';

        door.addEventListener("click", () => {
          if (!isDoorUnlocked(day)) {
            const dateStr = formatDate(new Date(currentYear, 11, day, 0, 0, 0));
            alert("Dieses T√ºrchen √∂ffnet sich erst am " + dateStr + ".");
            return;
          }

          const img = imageMap[day];
          if (!img) {
            alert("F√ºr dieses T√ºrchen wurde kein Bild hinterlegt.");
            return;
          }

          markDoorOpened(day, door);
          openPhoto(day, img);
        });

        grid.appendChild(door);
      }

      modalBackdrop.addEventListener("click", (event) => {
        if (event.target === modalBackdrop) {
          hideModal();
        }
      });

      closeModalBtn.addEventListener("click", hideModal);
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && modalBackdrop.classList.contains("visible")) {
          hideModal();
        }
      });

      function isDoorUnlocked(day) {
        const openDate = new Date(currentYear, 11, day, 0, 0, 0);
        return now >= openDate;
      }

      function loadOpenedDays() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return [];
          const arr = JSON.parse(raw);
          if (!Array.isArray(arr)) return [];
          return arr.map(Number).filter((n) => Number.isInteger(n) && n >= 1 && n <= TOTAL_DAYS);
        } catch {
          return [];
        }
      }

      function saveOpenedDays(days) {
        const unique = Array.from(new Set(days)).sort((a, b) => a - b);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(unique));
      }

      function markDoorOpened(day, doorEl) {
        if (!openedDays.includes(day)) {
          openedDays.push(day);
          saveOpenedDays(openedDays);
        }

        doorEl.classList.remove("locked", "unlocked");
        doorEl.classList.add("opened");

        const statusIcon = doorEl.querySelector(".door-status-icon");
        const statusText = doorEl.querySelector(".door-status-text");
        if (statusIcon) statusIcon.textContent = "üéâ";
        if (statusText) statusText.textContent = "Ge√∂ffnet";
      }

      function openPhoto(day, img) {
        modalImage.src = img.src;
        modalTitle.textContent = "T√ºrchen " + day + " ‚Äì " + day + ". Dezember";
        downloadLink.href = img.src;
        downloadLink.setAttribute(
          "download",
          "Advent_" + currentYear + "_Tag_" + String(day).padStart(2, "0") + ".jpg"
        );
        modalBackdrop.classList.add("visible");
      }

      function hideModal() {
        modalBackdrop.classList.remove("visible");
        modalImage.src = "";
      }

      function formatDate(date) {
        return date.toLocaleDateString("de-AT", {
          weekday: "short",
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
        });
      }
    })();
  </script>
</body>
</html>`;
    }
  </script>
</body>
</html>